@(promotions: Vector[models.Promotion])(implicit request: MessagesRequest[AnyContent])

@main("Gesti贸n de Promociones - Admin") {
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1> Gesti贸n de Promociones</h1>
        <p class="text-muted">Administra descuentos y ofertas especiales</p>
      </div>
      <div>
        <a href="@routes.AdminController.dashboard" class="btn btn-secondary me-2">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
        <a href="@routes.AdminController.newPromotionForm" class="btn btn-danger">
          <i class="bi bi-plus-circle me-2"></i>Nueva Promoci贸n
        </a>
      </div>
    </div>

    @request.flash.get("success").map { msg =>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>@msg
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    }

    @request.flash.get("error").map { msg =>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>@msg
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    }

    <!-- Resumen de estad铆sticas -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card border-success">
          <div class="card-body text-center">
            <h3 class="text-success mb-0">@models.PromotionRepo.countActive</h3>
            <small class="text-muted">Promociones Activas</small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-warning">
          <div class="card-body text-center">
            <h3 class="text-warning mb-0">@models.PromotionRepo.countUpcoming</h3>
            <small class="text-muted">Pr贸ximas</small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-secondary">
          <div class="card-body text-center">
            <h3 class="text-secondary mb-0">@models.PromotionRepo.countExpired</h3>
            <small class="text-muted">Finalizadas</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros de estado -->
    <ul class="nav nav-tabs mb-3" id="promoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button">
          <i class="bi bi-check-circle text-success"></i> Activas (@models.PromotionRepo.countActive)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button">
          <i class="bi bi-clock text-warning"></i> Pr贸ximas (@models.PromotionRepo.countUpcoming)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
          <i class="bi bi-list-ul"></i> Todas (@promotions.size)
        </button>
      </li>
    </ul>

    <div class="tab-content" id="promoTabsContent">
      <!-- ACTIVAS -->
      <div class="tab-pane fade show active" id="active" role="tabpanel">
        @defining(promotions.filter(_.isCurrentlyActive)) { activePromos =>
          @if(activePromos.isEmpty) {
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>No hay promociones activas en este momento.
            </div>
          } else {
            @promotionTable(activePromos, showActions = true)
          }
        }
      </div>

      <!-- PRXIMAS -->
      <div class="tab-pane fade" id="upcoming" role="tabpanel">
        @defining(promotions.filter(p => p.isActive && java.time.LocalDateTime.now().isBefore(p.startDate))) { upcomingPromos =>
          @if(upcomingPromos.isEmpty) {
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>No hay promociones pr贸ximas programadas.
            </div>
          } else {
            @promotionTable(upcomingPromos, showActions = true)
          }
        }
      </div>

      <!-- TODAS -->
      <div class="tab-pane fade" id="all" role="tabpanel">
        @if(promotions.isEmpty) {
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>No se han creado promociones a煤n.
            <a href="@routes.AdminController.newPromotionForm" class="alert-link">Crear la primera promoci贸n</a>
          </div>
        } else {
          @promotionTable(promotions, showActions = true)
        }
      </div>
    </div>

  </div>
}

@promotionTable(promos: Vector[models.Promotion], showActions: Boolean) = {
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Estado</th>
          <th>Nombre</th>
          <th>Descuento</th>
          <th>Tipo</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Tiempo restante</th>
          @if(showActions) { <th>Acciones</th> }
        </tr>
      </thead>
      <tbody>
        @promos.sortBy(_.startDate).reverse.map { promo =>
          <tr>
            <td>
              @if(promo.isCurrentlyActive) {
                <span class="badge bg-success">
                  <i class="bi bi-circle-fill"></i> ACTIVA
                </span>
              } else if(java.time.LocalDateTime.now().isBefore(promo.startDate) && promo.isActive) {
                <span class="badge bg-warning text-dark">
                  <i class="bi bi-clock"></i> PRXIMA
                </span>
              } else if(java.time.LocalDateTime.now().isAfter(promo.endDate)) {
                <span class="badge bg-secondary">
                  <i class="bi bi-x-circle"></i> FINALIZADA
                </span>
              } else if(!promo.isActive) {
                <span class="badge bg-danger">
                  <i class="bi bi-pause-circle"></i> PAUSADA
                </span>
              }
            </td>
            <td>
              <strong>@promo.name</strong><br>
              <small class="text-muted">@promo.description</small>
            </td>
            <td>
              <span class="badge bg-danger fs-6">-@{promo.discountPercent}%</span>
            </td>
            <td>
              @promo.targetType match {
                case models.PromotionTarget.All => {
                  <span class="badge bg-purple text-white">
                    <i class="bi bi-globe"></i> Todos
                  </span>
                }
                case models.PromotionTarget.Product => {
                  <span class="badge bg-info">
                    <i class="bi bi-box"></i> Productos (@promo.targetIds.size)
                  </span>
                }
                case models.PromotionTarget.Category => {
                  <span class="badge bg-primary">
                    <i class="bi bi-folder"></i> Categor铆as (@promo.targetIds.size)
                  </span>
                }
                case models.PromotionTarget.MediaType => {
                  <span class="badge bg-success">
                    <i class="bi bi-collection"></i> Tipos (@promo.targetIds.size)
                  </span>
                }
              }
            </td>
            <td>
              <small>@promo.startDate.format(java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm"))</small>
            </td>
            <td>
              <small>@promo.endDate.format(java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm"))</small>
            </td>
            <td>
              @if(promo.isCurrentlyActive) {
                @defining(promo.hoursRemaining) { hours =>
                  @if(hours > 48) {
                    <span class="text-success">@{promo.daysRemaining} d铆as</span>
                  } else if(hours > 24) {
                    <span class="text-warning">@{hours / 24} d铆as @{hours % 24}h</span>
                  } else if(hours > 0) {
                    <span class="text-danger"><strong>@{hours}h restantes</strong></span>
                  } else {
                    <span class="text-muted">Finalizando...</span>
                  }
                }
              } else if(java.time.LocalDateTime.now().isBefore(promo.startDate)) {
                <span class="text-muted">
                  Inicia en @{java.time.Duration.between(java.time.LocalDateTime.now(), promo.startDate).toDays} d铆as
                </span>
              } else {
                <span class="text-muted">-</span>
              }
            </td>
            @if(showActions) {
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="@routes.AdminController.editPromotionForm(promo.id)" 
                     class="btn btn-outline-primary" 
                     title="Editar">
                    <i class="bi bi-pencil"></i>
                  </a>
                  
                  @if(promo.isActive && (promo.isCurrentlyActive || java.time.LocalDateTime.now().isBefore(promo.startDate))) {
                    <form method="post" action="@routes.AdminController.togglePromotion(promo.id)" class="d-inline">
                      @helper.CSRF.formField
                      <button type="submit" class="btn btn-outline-warning" title="Pausar">
                        <i class="bi bi-pause-circle"></i>
                      </button>
                    </form>
                  } else if(!promo.isActive) {
                    <form method="post" action="@routes.AdminController.togglePromotion(promo.id)" class="d-inline">
                      @helper.CSRF.formField
                      <button type="submit" class="btn btn-outline-success" title="Reanudar">
                        <i class="bi bi-play-circle"></i>
                      </button>
                    </form>
                  }
                  
                  <form method="post" 
                        action="@routes.AdminController.deletePromotion(promo.id)" 
                        class="d-inline"
                        onsubmit="return confirm('驴Eliminar la promoci贸n @promo.name?');">
                    @helper.CSRF.formField
                    <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            }
          </tr>
        }
      </tbody>
    </table>
  </div>
}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tienda — LP Studios</title>

  <!-- ===== Bootstrap ===== -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- ===== Estilos locales ===== -->
  <link rel="stylesheet" href="/assets/stylesheets/fearless.css">
  <style>
    /* Fondo general coherente con el resto del sitio */
    body.bg-light {
      background: var(--color-bg-main, #e3eaf2) !important;
    }

    /* Sidebar de filtros */
    .shop-sidebar.card {
      background: #ffffff !important;
      color: #222 !important;
      border-color: var(--color-border, #b6c3d1) !important;
    }
    .shop-sidebar .card-header {
      background: var(--color-primary, #1976d2) !important;
      color: #fff !important;
    }
    .shop-sidebar .form-label,
    .shop-sidebar .category-link {
      color: #222 !important;
    }
    .shop-sidebar .btn-outline-secondary {
      background: #ffffff !important;
      color: var(--color-primary, #1976d2) !important;
      border-color: var(--color-primary, #1976d2) !important;
    }
    .shop-sidebar .btn-outline-secondary:hover {
      background: var(--color-primary, #1976d2) !important;
      color: #fff !important;
    }

    /* Cards de productos */
    .product-card.card {
      background: #ffffff !important;
      color: #222 !important;
      border-color: var(--color-border, #b6c3d1) !important;
    }
    .product-card .card-title {
      color: #222 !important;
    }

    /* Badges y alerts con paleta azul/verde */
    .badge.bg-info {
      background: var(--color-primary, #1976d2) !important;
      color: #fff !important;
    }
    .badge.bg-success {
      background: #2e7d32 !important;
    }
    .badge.bg-danger {
      background: #c62828 !important;
    }
    .alert-info {
      background: #e3f2fd !important;
      color: #0d47a1 !important;
      border-color: #bbdefb !important;
    }
    .alert-danger {
      background: #ffebee !important;
      color: #b71c1c !important;
      border-color: #ffcdd2 !important;
    }
  </style>
</head>

<body class="bg-light text-dark">

  <!-- ===== NAVBAR ===== -->
  <nav class="navbar bg-white border-bottom shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/" style="color: #1976d2 !important;">LP Studios</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-primary btn-sm" href="/shop">🛍️ Tienda</a>
        <!-- NAVBAR_BUTTONS -->
      </div>
    </div>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="container py-5">
    <h1 class="text-center mb-5">🎬 Catálogo de productos</h1>

    <div class="row">
      <!-- ===== SIDEBAR: FILTROS ===== -->
      <aside class="col-md-3 mb-4">
        <div class="card shop-sidebar shadow-sm">
          <div class="card-header text-white">
            <h5 class="mb-0">🔍 Filtros</h5>
          </div>
          <div class="card-body">
            <!-- Búsqueda -->
            <div class="mb-4">
              <label class="form-label fw-bold">Buscar</label>
              <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Buscar productos...">
              <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="clearFilters()">
                Limpiar filtros
              </button>
            </div>

            <hr class="border-secondary">

            <!-- Filtro por categoría -->
            <div>
              <label class="form-label fw-bold">Categorías</label>
              <div id="categories-tree"></div>
            </div>
          </div>
        </div>
      </aside>

      <!-- ===== CONTENIDO PRINCIPAL: PRODUCTOS ===== -->
      <section class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Catálogo</h2>
          <div class="d-flex gap-2 align-items-center">
            <select id="sort-select" class="form-select form-select-sm" style="width: auto;">
              <option value="downloads-desc">Más comprados</option>
              <option value="price-asc">Precio: menor a mayor</option>
              <option value="price-desc">Precio: mayor a menor</option>
              <option value="name-asc">Nombre: A-Z</option>
              <option value="name-desc">Nombre: Z-A</option>
              <option value="rating-desc">Mejor calificados</option>
            </select>
            <span class="text-muted">Mostrando <span id="product-count">0</span> producto(s)</span>
          </div>
        </div>

        <!-- Mensaje de info si no hay productos -->
        <!--
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          No se encontraron productos con los filtros aplicados.
          <a href="/shop" class="alert-link">Ver todos</a>
        </div>
        -->

        <!-- Grid de productos -->
        <div class="row g-3" id="products-grid">
          <!-- Producto Ejemplo -->
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card bg-dark border-secondary h-100 shadow-sm">
              <div class="ratio ratio-16x9">
                <img src="/assets/images/placeholder.jpg" alt="Producto ejemplo" class="card-img-top rounded-top">
              </div>
              <div class="card-body">
                <h5 class="card-title">Producto Ejemplo</h5>
                <p class="card-text small text-muted">Descripción breve del producto.</p>

                <p class="card-text mb-2">
                  <small class="text-muted">📁 <a href="/shop?category=1">Música</a></small>
                </p>

                <div class="mb-2">
                  <span class="badge bg-success">✅ Disponible (10 unidades)</span>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-semibold">$99.99</span>
                  <div class="btn-group">
                    <a class="btn btn-outline-info btn-sm" href="../product_detail.html" title="Ver detalles">👁️</a>
                    <button class="btn btn-primary btn-sm">🛒 Agregar</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer class="text-center text-muted py-4 mt-5 border-top">
    <small>© 2025 LP Studios — Tecnología, música y entretenimiento en un solo lugar.</small>
  </footer>

  <!-- ===== SCRIPTS ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/javascripts/notifications.js"></script>
  
  <script>
    let categories = [];
    
    // Función para obtener descendientes de una categoría
    function getDescendants(catId, cats) {
      const descendants = [];
      const children = cats.filter(c => c.parentId === catId);
      for (const child of children) {
        descendants.push(child.id);
        descendants.push(...getDescendants(child.id, cats));
      }
      return descendants;
    }
    
    // Función para renderizar el árbol de categorías (solo flecha y nombre clickable)
    function renderTree(parentId = null, level = 0) {
      const children = categories.filter(c => c.parentId === parentId);
      if (children.length === 0 && level === 0) {
        return '<div class="text-muted small">No hay categorías disponibles</div>';
      }
      return children.map(cat => {
        const hasChildren = categories.some(c => c.parentId === cat.id);
        const indent = level * 20;
        return `
          <div class="d-flex align-items-center mb-1" style="margin-left: ${indent}px;">
            ${hasChildren ? `<i class="bi bi-chevron-right me-2 toggle-icon" data-cat="${cat.id}" style="cursor:pointer;"></i>` : '<span class="me-2" style="width:16px;"></span>'}
            <span class="category-link text-light" data-cat="${cat.id}" style="cursor:pointer;">${cat.name}</span>
          </div>
          <div class="children" id="children-${cat.id}" style="display:none;"></div>
        `;
      }).join('');
    }

    async function loadCategories() {
      try {
        const response = await fetch('/api/categories');
        if (!response.ok) {
          throw new Error('No se pudo cargar categorías (HTTP ' + response.status + ')');
        }
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          throw new Error('Respuesta de categorías no es JSON válido');
        }
        const data = await response.json();
        console.log('Respuesta de /api/categories:', data); // DEBUG
        categories = Array.isArray(data.categories) ? data.categories : [];
        const treeHtml = renderTree();
        document.getElementById('categories-tree').innerHTML = treeHtml;
      } catch (error) {
        document.getElementById('categories-tree').innerHTML = '<div class="text-danger small">Error al cargar categorías</div>';
        categories = [];
        console.error('Error cargando categorías:', error);
      }
    }

    // Evento para expandir/collapse subcategorías dinámicamente
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('toggle-icon')) {
        const catId = parseInt(e.target.getAttribute('data-cat'));
        const childrenDiv = document.getElementById('children-' + catId);
        if (childrenDiv.style.display === 'none' || childrenDiv.style.display === '') {
          // Renderizar hijos solo al expandir
          childrenDiv.innerHTML = renderTree(catId, (parseInt(e.target.parentElement.style.marginLeft)||0)/20 + 1);
          childrenDiv.style.display = 'block';
          e.target.classList.remove('bi-chevron-right');
          e.target.classList.add('bi-chevron-down');
        } else {
          childrenDiv.style.display = 'none';
          e.target.classList.remove('bi-chevron-down');
          e.target.classList.add('bi-chevron-right');
        }
      }
      // Filtrar productos al hacer clic en el nombre de la categoría
      if (e.target.classList.contains('category-link')) {
        const catId = parseInt(e.target.getAttribute('data-cat'));
        selectedCategoryId = catId;
        loadProducts();
      }
    });
    
    // Variable global para la categoría seleccionada
    let selectedCategoryId = null;

    function clearFilters() {
      selectedCategoryId = null;
      const searchInput = document.getElementById('search-input');
      if (searchInput) searchInput.value = '';
      loadProducts();
    }

    // Cargar productos dinámicamente
    async function loadProducts() {
      try {
        await loadCategories();
        const response = await fetch('/api/media');
        const data = await response.json();
        let products = data.products || [];
        const isAdmin = data.isAdmin || false;
        const isLoggedIn = data.isLoggedIn || false;
        const query = document.getElementById('search-input').value.toLowerCase();
        // Filtrar productos por búsqueda
        if (query) {
          products = products.filter(p => 
            p.title.toLowerCase().includes(query) || 
            p.description.toLowerCase().includes(query)
          );
        }
        // Filtrar productos por categoría seleccionada
        if (selectedCategoryId) {
          const categoryIds = new Set();
          categoryIds.add(selectedCategoryId);
          getDescendants(selectedCategoryId, categories).forEach(id => categoryIds.add(id));
          products = products.filter(p => categoryIds.has(p.categoryId));
        }
        // Ordenar productos
        const sortSelect = document.getElementById('sort-select');
        const sortBy = sortSelect.value;
        sortProducts(products, sortBy);
        const grid = document.getElementById('products-grid');
        const countSpan = document.getElementById('product-count');
        if (products.length === 0) {
          grid.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No se encontraron productos con los filtros aplicados.
                <a href="/shop" class="alert-link">Ver todos</a>
              </div>
            </div>
          `;
          countSpan.textContent = '0';
          return;
        }
        // Generar cards de productos
        grid.innerHTML = products.map(product => {
          const isHardware = product.productType === 'hardware';
          const isOutOfStock = isHardware && product.stock <= 0;
          const stockBadgeClass = isHardware
            ? (isOutOfStock ? 'bg-danger' : 'bg-success')
            : 'bg-info';
          const stockLabel = isHardware
            ? (isOutOfStock ? '❌ Agotado' : `✅ Disponible (${product.stock})`)
            : '⚡ Entrega inmediata';

          let actionHtml;
          if (isAdmin) {
            actionHtml = `<a class="btn btn-warning btn-sm" href="/admin/media/${product.id}/edit" title="Editar producto">✏️</a>`;
          } else if (!isLoggedIn) {
            actionHtml = `<a class="btn btn-primary btn-sm" href="/login" title="Inicia sesión para comprar">🔑</a>`;
          } else {
            actionHtml = `<button class="btn btn-primary btn-sm ${isOutOfStock ? 'disabled' : ''}" 
                              onclick="addToCart(${product.id})">🛒</button>`;
          }
          return `
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card product-card h-100 shadow-sm position-relative">
              ${product.hasPromotion ? `
                <div class="position-absolute top-0 end-0 m-2">
                  <span class="badge bg-danger fs-6 shadow">
                    🔥 ${product.discountPercent}% OFF
                  </span>
                </div>
              ` : ''}
              <img src="${product.coverImage}" 
                   class="card-img-top" 
                   alt="${product.title}"
                   style="height: 200px; object-fit: cover;">
              <div class="card-body">
                <h5 class="card-title">${product.title}</h5>
                <p class="card-text small text-muted">${product.description.substring(0, 50)}${product.description.length > 50 ? '...' : ''}</p>
                <div class="mb-2">
                  <span class="badge ${stockBadgeClass}">
                    ${stockLabel}
                  </span>
                  <span class="badge bg-info">${isHardware ? 'Hardware' : 'Digital'}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  ${product.hasPromotion ? `
                    <div>
                      <span class="text-secondary text-decoration-line-through small d-block">Antes: $${product.price}</span>
                      <span class="fw-bold fs-5 text-warning">Ahora: $${product.discountedPrice.toFixed(2)}</span>
                    </div>
                  ` : `
                    <span class="fw-semibold fs-5 text-success">$${product.price}</span>
                  `}
                   <div class="btn-group">
                     <a class="btn btn-outline-info btn-sm" href="/shop/${product.id}" title="Ver detalles">👁️</a>
                      ${actionHtml}
                    </div>
                </div>
              </div>
            </div>
          </div>
        `}).join('');
        countSpan.textContent = products.length;
      } catch (error) {
        document.getElementById('products-grid').innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">
              ❌ Error al cargar productos
            </div>
          </div>
        `;
        console.error('Error cargando productos:', error);
      }
    }
    
    function sortProducts(products, sortBy) {
      switch (sortBy) {
        case 'price-asc':
          products.sort((a, b) => a.price - b.price);
          break;
        case 'price-desc':
          products.sort((a, b) => b.price - a.price);
          break;
        case 'name-asc':
          products.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'name-desc':
          products.sort((a, b) => b.title.localeCompare(a.title));
          break;
        case 'rating-desc':
          products.sort((a, b) => b.rating - a.rating);
          break;
        case 'downloads-desc':
        default:
          products.sort((a, b) => b.downloadCount - a.downloadCount);
          break;
      }
    }
    
    async function addToCart(productId) {
      try {
        const response = await fetch('/cart/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `mediaId=${productId}`,
          redirect: 'follow'
        });
        
        if (response.ok || response.redirected) {
          alert(`✅ Producto agregado al carrito`);
        } else {
          const text = await response.text();
          alert(`❌ Error: ${text}`);
        }
      } catch (error) {
        console.error('Error:', error);
        alert(`❌ Error al agregar al carrito`);
      }
    }
    
    // Cargar al inicio
    window.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      
      // Cambiar ordenamiento
      document.getElementById('sort-select').addEventListener('change', loadProducts);
      
      // Buscar en tiempo real
      document.getElementById('search-input').addEventListener('input', loadProducts);
    });
    
    // Event listeners para expandir/colapsar categorías
    document.addEventListener('click', e => {
      if (e.target.classList.contains('toggle-icon')) {
        const childrenDiv = e.target.parentElement.querySelector('.children');
        if (childrenDiv) {
          if (childrenDiv.style.display === 'none' || childrenDiv.style.display === '') {
            childrenDiv.style.display = 'block';
            e.target.classList.remove('bi-chevron-right');
            e.target.classList.add('bi-chevron-down');
          } else {
            childrenDiv.style.display = 'none';
            e.target.classList.remove('bi-chevron-down');
            e.target.classList.add('bi-chevron-right');
          }
        }
      }
    });
    
    // Event listener para checkboxes de categorías
    document.addEventListener('change', e => {
      if (e.target.type === 'checkbox' && e.target.closest('#categories-tree')) {
        loadProducts();
      }
    });
  </script>
</body>
</html>

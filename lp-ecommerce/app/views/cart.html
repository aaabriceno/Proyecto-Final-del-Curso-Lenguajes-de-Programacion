<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LP Studios | Carrito de Compras</title>

  <!-- ===== Bootstrap ===== -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- ===== Estilos locales ===== -->
  <link rel="stylesheet" href="/assets/stylesheets/fearless.css">
</head>

<body class="bg-light text-dark">

  <!-- ===== NAVBAR ===== -->
  <nav class="navbar border-bottom shadow-sm" style="background:#e3eaf2; color:#1976d2;">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/" style="color:#1976d2 !important;">LP Studios</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="/shop" style="background:#1976d2; color:#fff; border-color:#1976d2;">🛍️ Tienda</a>
        <a id="notificationBtn" class="btn btn-outline-warning btn-sm position-relative" href="/user/notifications" title="Notificaciones">
          <i class="bi bi-bell-fill"></i>
        </a>
        <a class="btn btn-outline-secondary btn-sm" href="/user/account">
          <i class="bi bi-person-circle"></i> Mi Cuenta
        </a>
        <a class="btn btn-outline-danger btn-sm" href="/logout">
          <i class="bi bi-box-arrow-right"></i> Salir
        </a>
      </div>
    </div>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="container py-5">
    <!-- ===== Encabezado ===== -->
    <div class="row mb-4">
      <div class="col">
        <h1 class="fw-bold">🛒 Carrito de Compras</h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-primary">Inicio</a></li>
            <li class="breadcrumb-item"><a href="/shop" class="text-decoration-none text-primary">Tienda</a></li>
            <li class="breadcrumb-item active text-secondary" aria-current="page">Carrito</li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Mensaje de error en modal (stock, etc.) -->
    <div class="modal fade" id="cartErrorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">No se pudo completar la compra</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p id="cartErrorMessage" class="mb-0"></p>
          </div>
          <div class="modal-footer">
            <a href="/shop" class="btn btn-primary">Ir a la Tienda</a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver al carrito</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Carrito vacío ===== -->
    <div class="card text-center shadow-sm border" id="empty-cart">
      <div class="card-body py-5">
        <i class="bi bi-cart-x" style="font-size: 4rem; color: #6c757d;"></i>
        <h3 class="mt-3">Tu carrito está vacío</h3>
        <p class="text-muted">Explora nuestra tienda y agrega productos.</p>
        <a href="/shop" class="btn btn-primary mt-3">
          🛍️ Ir a la Tienda
        </a>
      </div>
    </div>

    <!-- ===== Carrito con productos ===== -->
    <div class="row" id="cart-with-items" style="display: none;">
      <!-- ===== Lista de productos ===== -->
      <div class="col-lg-8">
        <div class="card mb-3 shadow-sm border-0">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">📦 Productos en tu carrito (__ITEM_COUNT__)</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Producto</th>
                    <th class="text-center">Precio Unit.</th>
                    <th class="text-center" style="width: 150px;">Cantidad</th>
                    <th class="text-center">Stock</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- CART_ROWS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Resumen de compra ===== -->
      <div class="col-lg-4">
        <div class="card sticky-top shadow-sm border-0" style="top: 20px;">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">💰 Resumen de Compra</h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal original:</span>
              <span class="text-muted">__SUBTOTAL__</span>
            </div>
            <div class="d-flex justify-content-between mb-2 text-danger">
              <span>🔥 Descuento:</span>
              <strong>__DISCOUNT__</strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between mb-3">
              <h5>Total a pagar:</h5>
              <h5 class="text-primary mb-0">__TOTAL__</h5>
            </div>
            <div class="alert alert-info small mb-3">
              💵 Tu saldo actual: <strong>__BALANCE__</strong>
            </div>

            <!-- Botones -->
            <form method="POST" action="/purchase">
              <button type="submit" class="btn btn-success w-100 mb-2" onclick="return confirm('¿Confirmar compra?')">
                ✅ Finalizar Compra (__TOTAL__)
              </button>
            </form>

            <a href="/shop" class="btn btn-outline-secondary w-100">
              ← Seguir Comprando
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== GIFT MODAL ===== -->
  <div class="modal fade" id="giftModal" tabindex="-1" aria-labelledby="giftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="giftModalLabel">🎁 Enviar como regalo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted">Vas a regalar <strong data-gift-title>este contenido</strong>.</p>
          <div class="alert alert-info d-none" data-gift-feedback></div>
          <form id="gift-form">
            <input type="hidden" name="mediaId">
            <div class="mb-3">
              <label class="form-label">Correo del destinatario</label>
              <input type="email" name="email" class="form-control" list="gift-recipient-suggestions" placeholder="ej: amigo@correo.com" required>
              <datalist id="gift-recipient-suggestions"></datalist>
              <small class="text-muted">Escribe al menos 2 letras para buscar.</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Mensaje (opcional)</label>
              <textarea name="message" class="form-control" rows="2" placeholder="Añade una nota"></textarea>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-warning">
                <i class="bi bi-gift me-1"></i>Enviar regalo
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPTS ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/javascripts/notifications.js"></script>
  <script>
    // Mostrar carrito según si hay items (controlado desde el servidor)
    const hasItems = false; // reemplazado en servidor
    document.getElementById('empty-cart').style.display = hasItems ? 'none' : 'block';
    document.getElementById('cart-with-items').style.display = hasItems ? 'flex' : 'none';
  </script>
  <script src="/assets/javascripts/gifting.js"></script>
  <script>
    (function () {
      const errorMsg = "__CART_ERROR__";
      if (errorMsg && errorMsg.trim() !== "") {
        const msgEl = document.getElementById('cartErrorMessage');
        if (msgEl) msgEl.textContent = errorMsg;
        const modalEl = document.getElementById('cartErrorModal');
        if (modalEl && typeof bootstrap !== "undefined") {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }
      }
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LP Studios | Gestión de Usuarios</title>

  <!-- ===== Bootstrap ===== -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- ===== Estilos locales ===== -->
  <link rel="stylesheet" href="/stylesheets/fearless.css">
</head>

<style>
</style>
</style>
</head>

<body>

  <!-- ===== NAVBAR ADMIN ===== -->
  <nav class="navbar border-bottom shadow-sm" style="background: #e3eaf2; color: #1976d2;">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/admin" style="color: #1976d2 !important;">LP Studios</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="/shop" style="background: #1976d2; color: #fff; border-color: #1976d2;">🛒 Tienda</a>
        <a class="btn btn-outline-danger btn-sm" href="/admin" style="background: #d32f2f; color: #fff; border-color: #d32f2f;">👨‍💼 Admin</a>
        <a class="btn btn-outline-light btn-sm" href="/login" style="background: #1976d2; color: #fff; border-color: #1976d2;">
          <i class="bi bi-box-arrow-right me-1"></i> Salir
        </a>
      </div>
    </div>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="container-fluid p-0" style="background: #e3eaf2; min-height: 100vh;">
    <div class="container py-5">

      <!-- ===== Encabezado ===== -->
      <div class="row mb-4">
        <div class="col">
          <h1 class="fw-bold">👥 Gestión de Usuarios</h1>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="/admin" class="text-decoration-none" style="color: #1976d2 !important;">Dashboard</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page" style="color: #1976d2 !important;">Usuarios</li>
            </ol>
          </nav>
        </div>
      </div>

      <!-- ===== Tabla de usuarios ===== -->
      <div class="card shadow-sm border-0" style="background: #fff; color: #222;">
        <div class="card-header d-flex justify-content-between align-items-center" style="background: #e3eaf2; color: #1976d2;">
          <h5 class="mb-0">📋 Total de usuarios: 0</h5>
          <button class="btn btn-sm btn-outline-light disabled" style="color: #1976d2; border-color: #1976d2; background: #fff;">
            <i class="bi bi-arrow-repeat me-1"></i> Actualizar
          </button>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table align-middle mb-0" style="background: #fff; color: #222;">
              <thead style="background: #e3eaf2; color: #1976d2;">
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Teléfono</th>
                  <th>Saldo</th>
                  <th>Gastado</th>
                  <th>Rol</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="9" class="text-center py-4" style="color: #1976d2;">
                    No hay usuarios registrados 😴
                  </td>
                </tr>

                <!-- Ejemplo de usuario -->
                <!--
                <tr>
                  <td>1</td>
                  <td><strong>Usuario Ejemplo</strong></td>
                  <td>usuario@example.com</td>
                  <td>+51 987654321</td>
                  <td><span class="badge bg-success">$500.00</span></td>
                  <td><span class="badge bg-info">$200.00</span></td>
                  <td><span class="badge bg-secondary">👤 Usuario</span></td>
                  <td><span class="badge bg-success">✅ Activo</span></td>
                  <td>
                    <div class="d-flex flex-wrap gap-2">
                      <form method="POST" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-warning">🚫 Desactivar</button>
                      </form>
                      <button type="button" class="btn btn-sm btn-primary"
                              data-bs-toggle="modal" 
                              data-bs-target="#addBalanceModal1">
                        💰 Agregar Saldo
                      </button>
                    </div>
                  </td>
                </tr>
                -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ===== Botón volver ===== -->
      <div class="mt-4">
        <a href="/admin" class="btn btn-outline-light" style="background: #1976d2; color: #fff; border-color: #1976d2;">
          <i class="bi bi-arrow-left me-2"></i> Volver al Dashboard
        </a>
      </div>
    </div>
  </main>

  <!-- ===== SCRIPTS ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Cargar usuarios dinámicamente desde la API
    async function loadUsers() {
      try {
        const response = await fetch('/api/users');
        if (!response.ok) {
          throw new Error('Error al cargar usuarios');
        }
        
        const data = await response.json();
        const users = data.users;
        
        // Actualizar contador
        document.querySelector('.card-header h5').textContent = 
          `📋 Total de usuarios: ${users.length}`;
        
        // Generar filas de la tabla
        const tbody = document.querySelector('tbody');
        if (users.length === 0) {
          tbody.innerHTML = `
            <tr>
                  <td colspan="9" class="text-center py-4" style="color: #1976d2;">
                    No hay usuarios registrados 😴
                  </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = users.map(user => `
            <tr>
              <td>${user.id}</td>
              <td><strong>${user.username}</strong></td>
              <td>${user.email}</td>
              <td>-</td>
              <td><span class="badge bg-success">$${user.balance.toFixed(2)}</span></td>
              <td><span class="badge bg-info">$${user.totalSpent.toFixed(2)}</span></td>
              <td><span class="badge ${user.isAdmin ? 'bg-danger' : 'bg-secondary'}">
                ${user.isAdmin ? '👨‍💼 Admin' : '👤 Usuario'}
              </span></td>
              <td><span class="badge ${user.isActive ? 'bg-success' : 'bg-warning'}">
                ${user.isActive ? '✅ Activo' : '🚫 Inactivo'}
              </span></td>
              <td>
                <form method="POST" action="/admin/users/${user.id}/toggle" class="d-inline">
                  <button type="submit" class="btn btn-sm ${user.isActive ? 'btn-warning' : 'btn-success'}">
                    ${user.isActive ? '🚫 Desactivar' : '✅ Activar'}
                  </button>
                </form>
              </td>
            </tr>
          `).join('');
        }
        
        // Habilitar botón de actualizar
        const btnRefresh = document.querySelector('.btn-outline-light.disabled');
        if (btnRefresh) {
          btnRefresh.classList.remove('disabled');
          btnRefresh.addEventListener('click', loadUsers);
        }
        
      } catch (error) {
        console.error('Error cargando usuarios:', error);
        document.querySelector('tbody').innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-danger py-4">
              ❌ Error al cargar usuarios
            </td>
          </tr>
        `;
      }
    }
    
    // Cargar al inicio
    window.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</body>
</html>
